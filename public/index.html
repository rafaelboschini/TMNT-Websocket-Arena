<html>
    <head>
        <meta charset="UTF-8" >
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.0/socket.io.js" integrity="sha512-+l9L4lMTFNy3dEglQpprf7jQBhQsQ3/WvOnjaN/+/L4i0jOstgScV0q2TjfvRF4V+ZePMDuZYIQtg5T4MKr+MQ==" crossorigin="anonymous"></script>
        <style>
            body{
                background-color: #2869c3;
            }

            canvas {
                margin: auto;
                display: block;
                zoom: 130%
            }
        </style>
    </head>
    <body>
        <canvas id="canvas" width="500px" height="500px"></canvas>
        <script type="text/javascript">
            var players = [];

            window.onload = function() {
                'use strict';
                
                var socket = undefined;
                var canvas = document.getElementById('canvas');
                var ctx = canvas.getContext('2d');
                var w = document.getElementById('canvas').offsetWidth;
                var h = document.getElementById('canvas').offsetHeight;
                var terrainImageLoaded = false,
                    houseImageLoaded = false,
                    pokeballImageLoaded = false,
                    playerImageLoaded = false;
                var objectSizes = 20;
                var speed = 100;
                var modifier = 100;
                var score = 0;

                //Socket IO Events
                socket = io.connect('http://localhost:3000', {reconnect: true});
                socket.on('getMyId', function(myid) {
                    localStorage.setItem('clientid', myid);
                    
                    if(players.length==0)
                    {
                        players.push({
                            clientid: myid,
                            posX: 13,
                            posY: 13
                        });

                        update();
                    }
                });

                socket.on('receivedMessage', function(playersUpdated) {
                    players = playersUpdated;                    
                    update();
                });

                //terrain image
                var terrainImage = new Image();
                terrainImage.onload = function() {
                    terrainImageLoaded = true;
                    assetsLoaded();
                };
                terrainImage.src = 'assets/images/island.jpg';

                //house image
                var houseImage = new Image();
                houseImage.onload = function() {
                    houseImageLoaded = true;
                    assetsLoaded();
                };
                houseImage.src = 'assets/images/house.png';

                //main sound
                var mainTheme = new Audio('https://drive.google.com/uc?id=1ljrlJ1UBrH4YnIpxH02jqR_oJeLZhkDv');
                mainTheme.loop = true;
                mainTheme.volume = 0.5;
                //mainTheme.play(); For God sake NO!

                //pokeball-selection
                var pokePick = new Audio('https://drive.google.com/uc?id=1ULOY_JeGQWJ0SOcxQfBtNQ77e20sWa31');
                pokePick.volume = 0;

                //player image
                var playerImage = new Image();
                playerImage.onload = function() {
                    pokeballImageLoaded = true;
                    assetsLoaded();
                };
                playerImage.src = 'assets/images/player.png';

                //pokeball image
                var pokeballImage = new Image();
                pokeballImage.onload = function() {
                    playerImageLoaded = true;
                    assetsLoaded();
                };
                pokeballImage.src = 'https://drive.google.com/uc?id=1XiXaiRlytnRI2ncwnBWyyef79guxI55X';

                /**
                 * It will hold all the pockeball data like x and y axis position
                 * sprite position and item distance is for determine which item is selected from the sprite - @todo future use for knowing on score which one player picked
                 * Also hold the generate position function that generates random positions if there is no collision.
                 * @Object
                 * @name pokeball
                 */
                var pokeball = {
                    x: 0,
                    y: 0,
                    spritePosition: 0,
                    spriteItemDistance: 33,
                };

                pokeball.generatePosition = function() {
                    do {
                        pokeball.x = Math.floor(Math.random() * 20) + 1;
                        pokeball.y = Math.floor(Math.random() * 16) + 4;
                    } while (check_collision(pokeball.x, pokeball.y));

                    pokeball.spritePosition = Math.floor(Math.random() * 4) + 0; // get position from 0-4
                };

                canvas.addEventListener('mousedown', function(event) {
                    player.move('down');
                });

                /**
                 * Holds all the player's info like x and y axis position, his current direction (facing).
                 * I have also incuded an object to hold the sprite position of each movement so i can call them
                 * I also included the move function in order to move the player - all the functionality for the movement is in there
                 * @Object
                 * @name pokeball
                 */
                var player = {
                    x: Math.round(w / 2 / objectSizes),
                    y: Math.round(h / 2 / objectSizes),
                    currentDirection: 'stand',
                    direction: {
                        stand: {
                            x: 0,
                            y: 0,
                        },
                        'down-1': {
                            x: 17,
                            y: 0,
                        },
                        'down-2': {
                            x: 34,
                            y: 0,
                        },
                        'up-1': {
                            x: 125,
                            y: 0,
                        },
                        'up-2': {
                            x: 142,
                            y: 0,
                        },
                        'left-1': {
                            x: 69,
                            y: 0,
                        },
                        'left-2': {
                            x: 87,
                            y: 0,
                        },
                        'right-1': {
                            x: 160,
                            y: 0,
                        },
                        'right-2': {
                            x: 178,
                            y: 0,
                        },
                    },
                };
                player.move = function(direction) {
                    /**
                     * A temporary object to hold the current x, y so if there is a collision with the new coordinates to fallback here
                     */
                    var hold_player = {
                        x: player.x,
                        y: player.y,
                    };

                    /**
                     * Decide here the direction of the user and do the neccessary changes on the directions
                     */
                    switch (direction) {
                        case 'left':
                            player.x -= speed / modifier;
                            if (player.currentDirection == 'stand') {
                                player.currentDirection = 'left-1';
                            } else if (player.currentDirection == 'left-1') {
                                player.currentDirection = 'left-2';
                            } else if (player.currentDirection == 'left-2') {
                                player.currentDirection = 'left-1';
                            } else {
                                player.currentDirection = 'left-1';
                            }
                            break;
                        case 'right':
                            player.x += speed / modifier;
                            if (player.currentDirection == 'stand') {
                                player.currentDirection = 'right-1';
                            } else if (player.currentDirection == 'right-1') {
                                player.currentDirection = 'right-2';
                            } else if (player.currentDirection == 'right-2') {
                                player.currentDirection = 'right-1';
                            } else {
                                player.currentDirection = 'right-1';
                            }
                            break;
                        case 'up':
                            player.y -= speed / modifier;

                            if (player.currentDirection == 'stand') {
                                player.currentDirection = 'up-1';
                            } else if (player.currentDirection == 'up-1') {
                                player.currentDirection = 'up-2';
                            } else if (player.currentDirection == 'up-2') {
                                player.currentDirection = 'up-1';
                            } else {
                                player.currentDirection = 'up-1';
                            }

                            break;
                        case 'down':
                            player.y += speed / modifier;

                            if (player.currentDirection == 'stand') {
                                player.currentDirection = 'down-1';
                            } else if (player.currentDirection == 'down-1') {
                                player.currentDirection = 'down-2';
                            } else if (player.currentDirection == 'down-2') {
                                player.currentDirection = 'down-1';
                            } else {
                                player.currentDirection = 'down-1';
                            }

                            break;
                    }

                    /**
                     * if there is a collision just fallback to the temp object i build before while not change back the direction so we can have a movement
                     */
                    if (check_collision(player.x, player.y)) {
                        player.x = hold_player.x;
                        player.y = hold_player.y;
                    }

                    /**
                     * If player finds the coordinates of pokeball the generate new one, play the sound and update the score
                     */
                    if (player.x == pokeball.x && player.y == pokeball.y) {
                        // found a pokeball !! create a new one
                        console.log('found a pokeball of ' + pokeball.spritePosition + '! Bravo! ');
                        pokePick.pause();
                        pokePick.currentTime = 0;
                        pokePick.play();
                        score += 1;
                        pokeball.generatePosition();
                    }

                    //send position data to socket
                    socket.emit('sendMessage', {
                        clientTimestamp: Date.now(),
                        posX: player.x,
                        posY: player.y,
                        dirX: player.direction[player.currentDirection].x,
                        dirY: player.direction[player.currentDirection].y,
                    });
                };

                /**
                 * Handle all the updates of the canvas and creates the objects
                 * @function
                 * @name update
                 */
                function update() {
                    ctx.drawImage(terrainImage, 0, 0);
                    ctx.drawImage(houseImage, 80, 60);

                    //Genboard
                    board();

                    //pokeball
                    ctx.drawImage(
                        pokeballImage,
                        pokeball.spritePosition * pokeball.spriteItemDistance,
                        0,
                        objectSizes,
                        objectSizes,
                        pokeball.x * objectSizes,
                        pokeball.y * objectSizes,
                        objectSizes,
                        objectSizes
                    );

                    $.each(players,(idx, item) => {
                        ctx.drawImage(
                            playerImage,
                            item.dirX,
                            item.dirY,
                            objectSizes - 2,
                            objectSizes,
                            item.posX * objectSizes + 10,
                            item.posY * objectSizes + 10,
                            objectSizes,
                            objectSizes
                        );
                    });


                }

                /**
                 * Our function that decides if there is a collision on the objects or not
                 * @function
                 * @name check_collision
                 * @param {Integer} x - The x axis
                 * @param {Integer} y - The y axis
                 */
                function check_collision(x, y) {
                    var foundCollision = false;

                    //collision stone temple
                    if ((x > 3 && x < 9 && y == 6) || (x > 4 && x < 9 && (y == 5 || y == 4 || y == 3))) {
                        console.log('Read the stone');
                        foundCollision = true;
                    }

                    //collision with de edges
                    if (
                        x < 1 ||
                        x > 20 ||
                        y < 2 ||
                        y > 20 ||
                        (y > 0 && y < 4 && (x == 20 || x == 19)) || //right corner
                        (y > 0 && y < 4 && (x == 2 || x == 3)) || //left corner
                        (y > 18 && (x == 2 || x == 3)) || //left corner
                        (x > 17 && (y == 19 || y == 20)) || //left corner
                        (x > 19 && (y == 17 || y == 18)) //left corner 2
                    ) {
                        console.log('Wiiiiilllsoooonnnnnn......help-me');
                        foundCollision = true;
                    }

                    return foundCollision;
                }

                /**
                 * Here we are creating our board on the bottom right with our score
                 * @todo maybe some mute button for the future?
                 * @function
                 * @name board
                 */
                function board() {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(w - 100, h - 70, 100, 70);

                    ctx.font = '18px Arial';
                    ctx.fillStyle = 'rgba(255, 255, 255, 1)';
                    ctx.fillText('You Found', w - 93, h - 45);

                    ctx.font = '14px Arial';
                    ctx.fillStyle = 'rgba(255, 255, 255, 1)';
                    ctx.fillText(score + ' poketballs', w - 85, h - 25);
                }

                /**
                 * Decide here if all the assets are ready to start updating
                 * @function
                 * @name assetsLoaded
                 */
                function assetsLoaded() {
                    if (
                        terrainImageLoaded == true &&
                        houseImageLoaded == true &&
                        pokeballImageLoaded == true &&
                        playerImageLoaded == true
                    ) {
                        pokeball.generatePosition();
                        update();
                    }
                }

                /**
                 * Assign of the arrow keys to call the player move
                 */
                document.onkeydown = function(e) {
                    e = e || window.event;

                    if (e.keyCode == '37') player.move('left');
                    else if (e.keyCode == '38') player.move('up');
                    else if (e.keyCode == '39') player.move('right');
                    else if (e.keyCode == '40') player.move('down');
                };
            };
        </script>
        
    </body>
</html>